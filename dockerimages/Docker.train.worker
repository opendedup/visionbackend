FROM suttlevision/base:latest

MAINTAINER Sam Silverberg sam.silverberg@gmail.com
ARG GCP_PROJECT
WORKDIR "/svbackend"
RUN rm -rf models
RUN git clone https://github.com/suttlevision/models.git && \
	cd models/research/ && \
	protoc object_detection/protos/*.proto --python_out=.

WORKDIR "/svbackend"
RUN rm -rf cocoapi
RUN git clone https://github.com/cocodataset/cocoapi.git && \
cd cocoapi/PythonAPI && \
make -j4 && \
cp -r pycocotools /svbackend/models/research/

WORKDIR /svbackend/models/research/
RUN bash object_detection/dataset_tools/create_pycocotools_package.sh /tmp/pycocotools && \
	python setup.py sdist && \
	(cd slim && python setup.py sdist) && \
	mkdir /svbackend/mlpackages/ && \
	cp dist/object_detection-0.1.tar.gz /svbackend/mlpackages/ && \
	cp slim/dist/slim-0.1.tar.gz /svbackend/mlpackages/ && \
	cp /tmp/pycocotools/pycocotools-2.0.tar.gz /svbackend/mlpackages/


WORKDIR "/svbackend"
COPY dockerimages/runscripts/train_worker.sh /svbackend/train_worker.sh
RUN ["chmod", "+x", "/svbackend/train_worker.sh"]
ENV LC_ALL=C.UTF-8
ENV LANG=C.UTF-8
ENV PYTHONPATH=/svbackend/tfpipeline:/svbackend/models/research/:/svbackend/models/research/slim:/svbackend/webserver/flaskr

# Downloading gcloud package
RUN curl https://dl.google.com/dl/cloudsdk/release/google-cloud-sdk.tar.gz > /tmp/google-cloud-sdk.tar.gz

# Installing the package
RUN mkdir -p /usr/local/gcloud \
  && tar -C /usr/local/gcloud -xvf /tmp/google-cloud-sdk.tar.gz \
  && /usr/local/gcloud/google-cloud-sdk/install.sh

# Adding the package path to local
ENV PATH $PATH:/usr/local/gcloud/google-cloud-sdk/bin

COPY tfpipeline /svbackend/tfpipeline
#Copy webserver for tests
COPY webserver /svbackend/webserver
#COPY $GCP_PROJECT-2285d752bd23.json /svbackend/
#RUN gcloud auth activate-service-account --key-file /svbackend/svbackend-209214-23885678398b.json
#RUN gcloud config set project $GCP_PROJECT

WORKDIR /svbackend/tfpipeline/tmodels/
RUN wget http://download.tensorflow.org/models/object_detection/faster_rcnn_inception_v2_coco_2018_01_28.tar.gz && \
	mkdir faster_rcnn_inception_v2_coco && \
	tar -xzvf faster_rcnn_inception_v2_coco_2018_01_28.tar.gz -C faster_rcnn_inception_v2_coco --strip-components=1 && rm faster_rcnn_inception_v2_coco_2018_01_28.tar.gz

RUN wget http://download.tensorflow.org/models/object_detection/ssd_resnet50_v1_fpn_shared_box_predictor_640x640_coco14_sync_2018_07_03.tar.gz && \
	mkdir ssd_resnet50_v1_fpn_shared_box_predictor_coco14_sync && \
	tar -xzvf ssd_resnet50_v1_fpn_shared_box_predictor_640x640_coco14_sync_2018_07_03.tar.gz -C ssd_resnet50_v1_fpn_shared_box_predictor_coco14_sync \ 
	--strip-components=1 && \
	rm ssd_resnet50_v1_fpn_shared_box_predictor_640x640_coco14_sync_2018_07_03.tar.gz

RUN wget http://download.tensorflow.org/models/object_detection/ssd_mobilenet_v1_fpn_shared_box_predictor_640x640_coco14_sync_2018_07_03.tar.gz && \
	mkdir ssd_mobilenet_v1_fpn_shared_box_predictor_coco14_sync && \
	tar -xzvf ssd_mobilenet_v1_fpn_shared_box_predictor_640x640_coco14_sync_2018_07_03.tar.gz \
	-C ssd_mobilenet_v1_fpn_shared_box_predictor_coco14_sync \
	--strip-components=1 && \
	rm ssd_mobilenet_v1_fpn_shared_box_predictor_640x640_coco14_sync_2018_07_03.tar.gz

RUN wget http://download.tensorflow.org/models/object_detection/faster_rcnn_resnet101_coco_2018_01_28.tar.gz && \
	mkdir faster_rcnn_resnet101_coco && \
	tar -xzvf faster_rcnn_resnet101_coco_2018_01_28.tar.gz \
	-C faster_rcnn_resnet101_coco \
	--strip-components=1 && \
	rm faster_rcnn_resnet101_coco_2018_01_28.tar.gz

RUN wget http://download.tensorflow.org/models/object_detection/faster_rcnn_inception_resnet_v2_atrous_coco_2018_01_28.tar.gz && \
	mkdir faster_rcnn_inception_resnet_v2_atrous_coco && \
	tar -xzvf faster_rcnn_inception_resnet_v2_atrous_coco_2018_01_28.tar.gz \
	-C faster_rcnn_inception_resnet_v2_atrous_coco \
	--strip-components=1 && \
	rm faster_rcnn_inception_resnet_v2_atrous_coco_2018_01_28.tar.gz

RUN wget http://download.tensorflow.org/models/object_detection/faster_rcnn_resnet50_coco_2018_01_28.tar.gz && \
	mkdir faster_rcnn_resnet50_coco && \
	tar -xzvffaster_rcnn_resnet50_coco_2018_01_28.tar.gz \
	-C faster_rcnn_resnet50_coco \
	--strip-components=1 && \
	rm faster_rcnn_resnet50_coco_2018_01_28.tar.gz

WORKDIR "/svbackend"
CMD ["./train_worker.sh"]
